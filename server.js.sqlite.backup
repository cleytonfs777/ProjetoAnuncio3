const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const cors = require('cors');
const bodyParser = require('body-parser');
const compression = require('compression');
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');
const bcrypt = require('bcryptjs');

const app = express();
const PORT = 3000;
const DB_PATH = path.join(__dirname, 'bm_control.db');

// Middleware
app.use(compression());
app.use(cors());
app.use(bodyParser.json({ limit: '50mb' }));
app.use(express.static(__dirname));

// Database Setup
const db = new sqlite3.Database(DB_PATH, (err) => {
    if (err) {
        console.error('Error opening database:', err.message);
    } else {
        console.log('Connected to SQLite database.');
        initDb();
    }
});

function initDb() {
    db.serialize(() => {
        // Seções
        db.run(`CREATE TABLE IF NOT EXISTS secoes (
            sigla TEXT PRIMARY KEY,
            desc TEXT
        )`);

        // Legendas
        db.run(`CREATE TABLE IF NOT EXISTS legendas (
            sigla TEXT PRIMARY KEY,
            nome TEXT,
            desc TEXT,
            color TEXT,
            text TEXT,
            horas REAL
        )`);

        // Militares - UNIFIED (includes user data: password, role)
        db.run(`CREATE TABLE IF NOT EXISTS militares (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            num TEXT UNIQUE,
            nome TEXT,
            secao TEXT,
            posto TEXT,
            typeHora TEXT,
            password TEXT,
            role TEXT
        )`);

        // Escala
        db.run(`CREATE TABLE IF NOT EXISTS escala (
            militar_id INTEGER,
            mes INTEGER,
            dia INTEGER,
            sigla TEXT,
            PRIMARY KEY (militar_id, mes, dia)
        )`);

        // Horas Extras
        db.run(`CREATE TABLE IF NOT EXISTS horas_extras (
            militar_id INTEGER,
            mes INTEGER,
            dia INTEGER,
            val REAL,
            obs TEXT,
            PRIMARY KEY (militar_id, mes, dia)
        )`);

        // Cargas Diárias
        db.run(`CREATE TABLE IF NOT EXISTS cargas_diarias (
            militar_id INTEGER,
            mes INTEGER,
            dia INTEGER,
            type TEXT,
            PRIMARY KEY (militar_id, mes, dia)
        )`);

        // Avisos
        db.run("DROP TABLE IF EXISTS avisos");
        db.run(`CREATE TABLE IF NOT EXISTS avisos (
            id TEXT PRIMARY KEY,
            ref_key TEXT,
            text TEXT,
            author TEXT,
            authorUsername TEXT,
            dateDisplay TEXT,
            createdAt TEXT
        )`);

        console.log("Tables initialized.");

        // Migration: add password and role columns if they don't exist
        db.all("PRAGMA table_info(militares)", (err, columns) => {
            if (!err && columns.length > 0) {
                const hasPassword = columns.some(c => c.name === 'password');
                const hasRole = columns.some(c => c.name === 'role');
                
                if (!hasPassword) {
                    console.log("Adding password column to militares...");
                    db.run("ALTER TABLE militares ADD COLUMN password TEXT");
                }
                if (!hasRole) {
                    console.log("Adding role column to militares...");
                    db.run("ALTER TABLE militares ADD COLUMN role TEXT");
                }
            }
            
            // Check if data needs to be imported
            checkAndImportInitialData();
        });
    });
}

function checkAndImportInitialData() {
    db.get("SELECT count(*) as count FROM militares", (err, row) => {
        if (err || !row || row.count === 0) {
            console.log("Database empty. Importing initial data from CSV files...");
            importInitialData();
        } else {
            console.log(`Database has ${row.count} military records.`);
            ensureAdminExists();
        }
    });
}

function importInitialData() {
    const secoesPath = path.join(__dirname, 'importacoes', 'DADOS PRINCIPAIS - SEÇOES.csv');
    const legendasPath = path.join(__dirname, 'importacoes', 'DADOS PRINCIPAIS - LEGENDA.csv');
    const militaresPath = path.join(__dirname, 'importacoes', 'DADOS PRINCIPAIS - MILITARES.csv');

    db.serialize(() => {
        db.run("BEGIN TRANSACTION");

        // 1. Import Seções
        if (fs.existsSync(secoesPath)) {
            console.log("Importing seções...");
            const data = parseCSV(fs.readFileSync(secoesPath, 'utf8'));
            const stmt = db.prepare("INSERT OR IGNORE INTO secoes (sigla, desc) VALUES (?, ?)");
            data.forEach(row => {
                const sigla = row['SIGLA'] || row['sigla'];
                const desc = row['NOME/DESCRIÇÃO'] || row['nome'] || row['DESCRIÇÃO'];
                if (sigla && desc) {
                    stmt.run(sigla, desc.trim());
                }
            });
            stmt.finalize();
            console.log(`Imported ${data.length} seções.`);
        }

        // 2. Import Legendas
        if (fs.existsSync(legendasPath)) {
            console.log("Importing legendas...");
            const data = parseCSV(fs.readFileSync(legendasPath, 'utf8'));
            const stmt = db.prepare("INSERT OR IGNORE INTO legendas (sigla, nome, desc, horas, color, text) VALUES (?, ?, ?, ?, ?, ?)");
            
            const defaultColors = {
                'P': { color: '#dcfce7', text: '#166534' },
                'PM': { color: '#fef9c3', text: '#854d0e' },
                'PT': { color: '#e0f2fe', text: '#0369a1' },
                'FO': { color: '#dbeafe', text: '#1e40af' },
                'F': { color: '#fef9c3', text: '#854d0e' },
                'LM': { color: '#fee2e2', text: '#991b1b' },
                'TAF': { color: '#fce7f3', text: '#be185d' },
                'TPB': { color: '#e0e7ff', text: '#3730a3' },
                'DSP': { color: '#fed7aa', text: '#9a3412' },
                '4ESF': { color: '#c7d2fe', text: '#3730a3' },
                'C': { color: '#d1fae5', text: '#065f46' },
                'PSO': { color: '#fecaca', text: '#991b1b' },
                'INT': { color: '#bfdbfe', text: '#1e40af' },
                'AUL': { color: '#ddd6fe', text: '#5b21b6' },
                'OD': { color: '#e5e7eb', text: '#374151' }
            };

            data.forEach(row => {
                const sigla = row['SIGLA'] || row['sigla'];
                const desc = row['DESCRIÇÃO'] || row['desc'] || row['descricao'];
                let horas = parseFloat(row['HORA'] || row['horas'] || '0');
                
                if (isNaN(horas) && row['HORA']) {
                    if (row['HORA'].includes('8')) horas = 8;
                    else if (row['HORA'].includes('6')) horas = 6;
                }

                const colors = defaultColors[sigla] || { color: '#e5e7eb', text: '#374151' };

                if (sigla) {
                    stmt.run(sigla, desc || sigla, desc || '', horas, colors.color, colors.text);
                }
            });
            stmt.finalize();
            console.log(`Imported ${data.length} legendas.`);
        }

        // 3. Import Militares (with user data)
        if (fs.existsSync(militaresPath)) {
            console.log("Importing militares...");
            const data = parseCSV(fs.readFileSync(militaresPath, 'utf8'));
            const stmt = db.prepare("INSERT OR IGNORE INTO militares (num, nome, secao, posto, typeHora, password, role) VALUES (?, ?, ?, ?, ?, ?, ?)");
            
            data.forEach(row => {
                const matricula = row['Matricula'] || row['matricula'];
                const nome = row['Nome Completo'] || row['nome'];
                const secaoSigla = row['Seçao Sigla'] || row['Seção Sigla'] || row['secao'];
                const posto = row['PG'] || row['pg'] || '';
                let cargaHoraria = row['Carga Horaria'] || row['carga_horaria'] || '8h';
                
                if (posto && posto.toLowerCase().includes('civil')) {
                    cargaHoraria = '8h';
                }

                const acessoSistema = row['Acesso ao Sistema'] || row['acesso'];
                const perfil = row['Perfil'] || row['perfil'] || 'USUARIO';
                const senha = row['Senha'] || row['senha'] || 'cbmmg193';

                if (matricula && nome) {
                    let hashedPassword = null;
                    let role = null;
                    
                    if (acessoSistema && (acessoSistema === 'TRUE' || acessoSistema === 'true' || acessoSistema === '1')) {
                        hashedPassword = bcrypt.hashSync(senha, 10);
                        role = perfil.toUpperCase();
                    }
                    
                    stmt.run(matricula, nome, secaoSigla || '', posto, cargaHoraria, hashedPassword, role);
                }
            });
            stmt.finalize();
            console.log(`Imported ${data.length} militares.`);
        }

        db.run("COMMIT", (err) => {
            if (err) {
                console.error("Error committing initial data:", err.message);
            } else {
                console.log("Initial data import complete.");
                ensureAdminExists();
            }
        });
    });
}

function ensureAdminExists() {
    // Ensure at least one ADMIN exists (142.924-0)
    const adminNum = "142.924-0";
    const adminUsername = adminNum.replace(/\D/g, '');
    
    db.get("SELECT * FROM militares WHERE num = ?", [adminNum], (err, row) => {
        if (!row) {
            // Create admin if doesn't exist
            console.log("Creating default Admin (142.924-0)...");
            const hashedPassword = bcrypt.hashSync(adminUsername, 10);
            db.run(
                "INSERT INTO militares (num, nome, secao, posto, typeHora, password, role) VALUES (?, ?, ?, ?, ?, ?, ?)",
                [adminNum, "Administrador do Sistema", "S-1", "Cap", "6h", hashedPassword, "ADMIN"]
            );
        } else if (row.role !== 'ADMIN') {
            // Always ensure this specific user is ADMIN
            console.log("Ensuring 142.924-0 has ADMIN role...");
            const hashedPassword = bcrypt.hashSync(adminUsername, 10);
            db.run("UPDATE militares SET password = ?, role = ? WHERE num = ?", [hashedPassword, "ADMIN", adminNum]);
        }
    });
}

// Helper function to parse CSV content
function parseCSV(csvContent) {
    const lines = csvContent.trim().split(/\r?\n/);
    if (lines.length === 0) return [];

    const firstLine = lines[0];
    let separator = ',';
    if (firstLine.includes('\t')) separator = '\t';
    else if (firstLine.includes(';') && !firstLine.includes(',')) separator = ';';

    const cleanBox = (str) => str ? str.trim().replace(/^"|"$/g, '') : '';
    const headers = firstLine.split(separator).map(cleanBox);
    
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = lines[i].split(separator).map(cleanBox);
        const row = {};
        headers.forEach((header, index) => {
            row[header] = values[index] || '';
        });
        data.push(row);
    }
    
    return data;
}

// ============================================
// API Routes
// ============================================

// Login Endpoint - now queries militares table
app.post('/api/login', (req, res) => {
    const rawUsername = req.body.username || '';
    const username = rawUsername.replace(/\D/g, ''); // Extract only digits
    const password = req.body.password;
    
    // Query militares by num (cleaned to digits)
    db.get("SELECT * FROM militares WHERE REPLACE(REPLACE(REPLACE(num, '.', ''), '-', ''), ' ', '') = ?", [username], (err, row) => {
        if (err) return res.status(500).json({ error: "Database error" });
        if (!row) return res.status(401).json({ error: "Credenciais inválidas" });
        if (!row.password || !row.role) return res.status(401).json({ error: "Usuário sem acesso ao sistema" });

        if (!bcrypt.compareSync(password, row.password)) {
            return res.status(401).json({ error: "Credenciais inválidas" });
        }

        const token = crypto.randomBytes(16).toString('hex');
        
        res.json({
            success: true,
            user: {
                username: row.num.replace(/\D/g, ''),
                name: row.nome,
                role: row.role
            },
            token: token
        });
    });
});

// GET Full Data
app.get('/api/data', (req, res) => {
    const response = {
        secoes: [],
        legendas: [],
        militares: [],
        escala: {},
        horasExtras: {},
        cargasDiarias: {},
        avisos: {}
    };

    db.serialize(() => {
        db.all("SELECT * FROM secoes", (err, rows) => {
            if (err) return res.status(500).json({ error: err.message });
            response.secoes = rows;
            
            db.all("SELECT * FROM legendas", (err, rows) => {
                if (err) return res.status(500).json({ error: err.message });
                response.legendas = rows;

                db.all("SELECT id, num, nome, secao, posto, typeHora, role FROM militares", (err, rows) => {
                    if (err) return res.status(500).json({ error: err.message });
                    
                    // Map role as user_role for frontend compatibility
                    rows.forEach(m => {
                        m.user_role = m.role || null;
                    });
                    response.militares = rows;

                    db.all("SELECT * FROM escala", (err, rows) => {
                        if (err) return res.status(500).json({ error: err.message });
                        rows.forEach(r => {
                            response.escala[`${r.militar_id}-${r.mes}-${r.dia}`] = r.sigla;
                        });

                        db.all("SELECT * FROM horas_extras", (err, rows) => {
                            if (err) return res.status(500).json({ error: err.message });
                            rows.forEach(r => {
                                response.horasExtras[`${r.militar_id}-${r.mes}-${r.dia}`] = { val: r.val, obs: r.obs };
                            });

                            db.all("SELECT * FROM cargas_diarias", (err, rows) => {
                                if (err) return res.status(500).json({ error: err.message });
                                rows.forEach(r => {
                                    response.cargasDiarias[`${r.militar_id}-${r.mes}-${r.dia}`] = r.type;
                                });

                                db.all("SELECT * FROM avisos", (err, rows) => {
                                    if (err) return res.status(500).json({ error: err.message });
                                    rows.forEach(r => {
                                        const key = r.ref_key;
                                        if (!response.avisos[key]) response.avisos[key] = [];
                                        response.avisos[key].push({
                                            id: r.id,
                                            text: r.text,
                                            author: r.author,
                                            authorUsername: r.authorUsername,
                                            dateDisplay: r.dateDisplay,
                                            createdAt: r.createdAt
                                        });
                                    });

                                    res.json(response);
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});

// POST Save Full Data
app.post('/api/save', (req, res) => {
    const userRole = req.headers['x-role'];
    
    if (userRole === 'USUARIO') {
        return res.status(403).json({ error: "Permissão negada. Usuários não podem salvar dados." });
    }

    const data = req.body;
    
    db.serialize(() => {
        db.run("BEGIN TRANSACTION");
        
        // Save Escala
        db.run("DELETE FROM escala");
        const stmtEsc = db.prepare("INSERT INTO escala (militar_id, mes, dia, sigla) VALUES (?, ?, ?, ?)");
        Object.keys(data.escala || {}).forEach(key => {
            const [id, mes, dia] = key.split('-').map(Number);
            const sigla = data.escala[key];
            if (sigla && sigla.trim() !== '') {
                stmtEsc.run(id, mes, dia, sigla);
            }
        });
        stmtEsc.finalize();

        // Save Horas Extras
        db.run("DELETE FROM horas_extras");
        const stmtHE = db.prepare("INSERT INTO horas_extras (militar_id, mes, dia, val, obs) VALUES (?, ?, ?, ?, ?)");
        Object.keys(data.horasExtras || {}).forEach(key => {
            const [id, mes, dia] = key.split('-').map(Number);
            const he = data.horasExtras[key];
            if (he && (he.val || he.obs)) {
                stmtHE.run(id, mes, dia, he.val || 0, he.obs || '');
            }
        });
        stmtHE.finalize();

        // Save Cargas Diárias
        db.run("DELETE FROM cargas_diarias");
        const stmtCD = db.prepare("INSERT INTO cargas_diarias (militar_id, mes, dia, type) VALUES (?, ?, ?, ?)");
        Object.keys(data.cargasDiarias || {}).forEach(key => {
            const [id, mes, dia] = key.split('-').map(Number);
            const type = data.cargasDiarias[key];
            if (type) {
                stmtCD.run(id, mes, dia, type);
            }
        });
        stmtCD.finalize();

        // Save Avisos
        db.run("DELETE FROM avisos");
        const stmtAv = db.prepare("INSERT INTO avisos (id, ref_key, text, author, authorUsername, dateDisplay, createdAt) VALUES (?, ?, ?, ?, ?, ?, ?)");
        Object.keys(data.avisos || {}).forEach(key => {
            const avisosList = data.avisos[key];
            if (Array.isArray(avisosList)) {
                avisosList.forEach(av => {
                    stmtAv.run(av.id, key, av.text, av.author, av.authorUsername || null, av.dateDisplay, av.createdAt);
                });
            }
        });
        stmtAv.finalize();

        // Save Legendas
        db.run("DELETE FROM legendas");
        const stmtLeg = db.prepare("INSERT INTO legendas (sigla, nome, desc, color, text, horas) VALUES (?, ?, ?, ?, ?, ?)");
        (data.legendas || []).forEach(l => {
            stmtLeg.run(l.sigla, l.nome || l.desc, l.desc || '', l.color, l.text, l.horas);
        });
        stmtLeg.finalize();

        db.run("COMMIT", (err) => {
            if (err) return res.status(500).json({ error: err.message });
            res.json({ success: true });
        });
    });
});

// --- MILITAR MANAGEMENT ---

app.post('/api/manage/militar', (req, res) => {
    const requestRole = req.headers['x-role'];
    if (requestRole !== 'ADMIN') {
        return res.status(403).json({ error: 'Acesso negado. Apenas ADMIN pode gerenciar militares.' });
    }

    const { id, num, nome, secao, posto, typeHora, hasAccess, password, role } = req.body;

    if (!num || !nome) {
        return res.status(400).json({ error: 'Dados incompletos.' });
    }

    let finalPassword = null;
    let finalRole = null;

    if (hasAccess) {
        if (!role) {
            return res.status(400).json({ error: "Perfil de acesso obrigatório." });
        }
        finalRole = role;
        
        if (password && password.trim() !== '') {
            finalPassword = bcrypt.hashSync(password, 10);
        }
    }

    if (id) {
        // Update existing militar
        if (hasAccess && password && password.trim() !== '') {
            db.run(
                "UPDATE militares SET num = ?, nome = ?, secao = ?, posto = ?, typeHora = ?, password = ?, role = ? WHERE id = ?",
                [num, nome, secao, posto, typeHora, finalPassword, finalRole, id],
                function(err) {
                    if (err) return res.status(500).json({ error: err.message });
                    res.json({ success: true });
                }
            );
        } else if (hasAccess) {
            // Update without changing password
            db.run(
                "UPDATE militares SET num = ?, nome = ?, secao = ?, posto = ?, typeHora = ?, role = ? WHERE id = ?",
                [num, nome, secao, posto, typeHora, finalRole, id],
                function(err) {
                    if (err) return res.status(500).json({ error: err.message });
                    res.json({ success: true });
                }
            );
        } else {
            // Remove access (clear password and role)
            db.run(
                "UPDATE militares SET num = ?, nome = ?, secao = ?, posto = ?, typeHora = ?, password = NULL, role = NULL WHERE id = ?",
                [num, nome, secao, posto, typeHora, id],
                function(err) {
                    if (err) return res.status(500).json({ error: err.message });
                    res.json({ success: true });
                }
            );
        }
    } else {
        // Insert new militar
        if (hasAccess && !password) {
            return res.status(400).json({ error: "Senha obrigatória para novo usuário com acesso." });
        }
        
        db.run(
            "INSERT INTO militares (num, nome, secao, posto, typeHora, password, role) VALUES (?, ?, ?, ?, ?, ?, ?)",
            [num, nome, secao, posto, typeHora, finalPassword, finalRole],
            function(err) {
                if (err) return res.status(500).json({ error: err.message });
                res.json({ success: true, id: this.lastID });
            }
        );
    }
});

app.delete('/api/manage/militar/:id', (req, res) => {
    const requestRole = req.headers['x-role'];
    if (requestRole !== 'ADMIN') {
        return res.status(403).json({ error: 'Acesso negado.' });
    }

    const id = req.params.id;

    db.serialize(() => {
        db.run("BEGIN TRANSACTION");
        
        db.run("DELETE FROM militares WHERE id = ?", [id]);
        db.run("DELETE FROM escala WHERE militar_id = ?", [id]);
        db.run("DELETE FROM horas_extras WHERE militar_id = ?", [id]);
        db.run("DELETE FROM cargas_diarias WHERE militar_id = ?", [id]);

        db.run("COMMIT", (err) => {
            if (err) return res.status(500).json({ error: "Erro na exclusão" });
            res.json({ success: true });
        });
    });
});

// Password change
app.post('/api/user/password', (req, res) => {
    const rawUsername = req.body.username || '';
    const username = rawUsername.replace(/\D/g, '');
    const { oldPassword, newPassword } = req.body;
    
    if (!username || !oldPassword || !newPassword) {
        return res.status(400).json({ error: "Dados incompletos." });
    }

    db.get("SELECT * FROM militares WHERE REPLACE(REPLACE(REPLACE(num, '.', ''), '-', ''), ' ', '') = ?", [username], (err, row) => {
        if (err) return res.status(500).json({ error: "Erro de banco de dados" });
        if (!row || !row.password) return res.status(401).json({ error: "Usuário não encontrado ou sem acesso." });
        
        if (!bcrypt.compareSync(oldPassword, row.password)) {
            return res.status(401).json({ error: "Senha atual incorreta." });
        }

        const hashedNew = bcrypt.hashSync(newPassword, 10);
        db.run("UPDATE militares SET password = ? WHERE id = ?", [hashedNew, row.id], (err) => {
            if (err) return res.status(500).json({ error: "Erro ao atualizar senha" });
            res.json({ success: true });
        });
    });
});

// List users (militares with access)
app.get('/api/users', (req, res) => {
    if (req.headers['x-role'] !== 'ADMIN') {
        return res.status(403).json({ error: 'Acesso negado' });
    }
    
    db.all("SELECT id, num as username, role, nome as name FROM militares WHERE password IS NOT NULL AND role IS NOT NULL", (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows);
    });
});

// --- CSV IMPORT ENDPOINTS ---

app.post('/api/import/secoes', (req, res) => {
    const requestRole = req.headers['x-role'];
    if (requestRole !== 'ADMIN') {
        return res.status(403).json({ error: 'Acesso negado.' });
    }

    const { csvContent } = req.body;
    if (!csvContent) {
        return res.status(400).json({ error: 'Nenhum conteúdo CSV fornecido.' });
    }

    try {
        const data = parseCSV(csvContent);
        
        db.serialize(() => {
            db.run("BEGIN TRANSACTION");
            
            const stmt = db.prepare("INSERT OR IGNORE INTO secoes (sigla, desc) VALUES (?, ?)");
            let successCount = 0;
            let errorCount = 0;

            data.forEach(row => {
                const sigla = row['SIGLA'] || row['sigla'];
                const desc = row['NOME/DESCRIÇÃO'] || row['nome'] || row['DESCRIÇÃO'];
                
                if (sigla && desc) {
                    stmt.run(sigla, desc, (err) => {
                        if (!err) successCount++;
                        else errorCount++;
                    });
                } else {
                    errorCount++;
                }
            });

            stmt.finalize();
            
            db.run("COMMIT", (err) => {
                if (err) return res.status(500).json({ error: "Erro ao salvar seções: " + err.message });
                res.json({ success: true, successCount, errorCount, message: `${successCount} seção(ões) importada(s)` });
            });
        });
    } catch (err) {
        res.status(400).json({ error: "Erro ao processar CSV: " + err.message });
    }
});

app.post('/api/import/legendas', (req, res) => {
    const requestRole = req.headers['x-role'];
    if (requestRole !== 'ADMIN') {
        return res.status(403).json({ error: 'Acesso negado.' });
    }

    const { csvContent } = req.body;
    if (!csvContent) {
        return res.status(400).json({ error: 'Nenhum conteúdo CSV fornecido.' });
    }

    try {
        const data = parseCSV(csvContent);
        
        db.serialize(() => {
            db.run("BEGIN TRANSACTION");
            
            const stmt = db.prepare("INSERT OR IGNORE INTO legendas (sigla, nome, desc, horas, color, text) VALUES (?, ?, ?, ?, ?, ?)");
            let successCount = 0;
            let errorCount = 0;

            const defaultColors = {
                'P': { color: '#dcfce7', text: '#166534' },
                'PM': { color: '#fef9c3', text: '#854d0e' },
                'PT': { color: '#e0f2fe', text: '#0369a1' },
                'FO': { color: '#dbeafe', text: '#1e40af' },
                'F': { color: '#fef9c3', text: '#854d0e' },
                'LM': { color: '#fee2e2', text: '#991b1b' },
                'TAF': { color: '#fce7f3', text: '#be185d' },
                'TPB': { color: '#e0e7ff', text: '#3730a3' },
                'DSP': { color: '#fed7aa', text: '#9a3412' },
                '4ESF': { color: '#c7d2fe', text: '#3730a3' }
            };

            data.forEach(row => {
                const sigla = row['SIGLA'] || row['sigla'];
                let nome = row['NOME'] || row['nome'];
                let desc = row['DESCRIÇÃO'] || row['desc'] || row['descricao'];
                
                if (!nome && desc) {
                    nome = desc;
                    desc = '';
                }

                let horas = parseFloat(row['HORA'] || row['horas'] || '0');
                if (isNaN(horas) && row['HORA']) {
                    if (row['HORA'].includes('8')) horas = 8;
                    else if (row['HORA'].includes('6')) horas = 6;
                }

                const colors = defaultColors[sigla] || { color: '#e5e7eb', text: '#374151' };

                if (sigla && nome) {
                    stmt.run(sigla, nome, desc, horas, colors.color, colors.text, (err) => {
                        if (!err) successCount++;
                        else errorCount++;
                    });
                } else {
                    errorCount++;
                }
            });

            stmt.finalize();
            
            db.run("COMMIT", (err) => {
                if (err) return res.status(500).json({ error: "Erro ao salvar legendas: " + err.message });
                res.json({ success: true, successCount, errorCount, message: `${successCount} legenda(s) importada(s)` });
            });
        });
    } catch (err) {
        res.status(400).json({ error: "Erro ao processar CSV: " + err.message });
    }
});

app.post('/api/import/militares', (req, res) => {
    const requestRole = req.headers['x-role'];
    if (requestRole !== 'ADMIN') {
        return res.status(403).json({ error: 'Acesso negado.' });
    }

    const { csvContent } = req.body;
    if (!csvContent) {
        return res.status(400).json({ error: 'Nenhum conteúdo CSV fornecido.' });
    }

    try {
        const data = parseCSV(csvContent);
        
        db.all("SELECT num FROM militares", (err, rows) => {
            if (err) return res.status(500).json({ error: "Erro ao ler banco de dados: " + err.message });
            
            const existingNums = new Set(rows.map(r => r.num));
            let successCount = 0;
            let errorCount = 0;
            
            db.serialize(() => {
                db.run("BEGIN TRANSACTION");
                
                const stmt = db.prepare("INSERT INTO militares (num, nome, secao, posto, typeHora, password, role) VALUES (?, ?, ?, ?, ?, ?, ?)");
                
                data.forEach(row => {
                    const matricula = row['Matricula'] || row['matricula'];
                    const nome = row['Nome Completo'] || row['nome'];
                    const secaoSigla = row['Seçao Sigla'] || row['Seção Sigla'] || row['secao'];
                    const posto = row['PG'] || row['pg'] || '';
                    let cargaHoraria = row['Carga Horaria'] || row['carga_horaria'] || '8h';
                    
                    if (posto && posto.toLowerCase().includes('civil')) {
                        cargaHoraria = '8h';
                    }

                    const acessoSistema = row['Acesso ao Sistema'] || row['acesso'];
                    const perfil = row['Perfil'] || row['perfil'] || 'USUARIO';
                    const senha = row['Senha'] || row['senha'] || 'cbmmg193';

                    if (matricula && nome && secaoSigla) {
                        if (!existingNums.has(matricula)) {
                            let hashedPassword = null;
                            let role = null;
                            
                            if (acessoSistema && (acessoSistema === 'TRUE' || acessoSistema === 'true' || acessoSistema === '1')) {
                                hashedPassword = bcrypt.hashSync(senha, 10);
                                role = perfil.toUpperCase();
                            }
                            
                            stmt.run(matricula, nome, secaoSigla, posto, cargaHoraria, hashedPassword, role, (err) => {
                                if (err) errorCount++;
                                else successCount++;
                            });
                            
                            existingNums.add(matricula);
                        }
                    } else {
                        errorCount++;
                    }
                });

                stmt.finalize();
                
                db.run("COMMIT", (err) => {
                    if (err) return res.status(500).json({ error: "Erro ao salvar militares: " + err.message });
                    res.json({ success: true, successCount, errorCount, message: `${successCount} militar(es) importado(s)` });
                });
            });
        });
    } catch (err) {
        res.status(400).json({ error: "Erro ao processar CSV: " + err.message });
    }
});

app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
});
